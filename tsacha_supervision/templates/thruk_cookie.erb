# extend default virtual host. put/include these rewrite rules in https or
# any other virtual host if you want to enable cookie authentication

# redirect to a startup page when there is no pidfile yet
RewriteCond %{REQUEST_METHOD}        GET
RewriteCond %{REQUEST_URI}           !^/naemon/startup.html
RewriteCond %{REQUEST_URI}           !^/naemon/side.html
RewriteCond %{REQUEST_URI}           !^/naemon/.*\.(css|png|js)
RewriteCond %{REQUEST_URI}           ^/naemon
RewriteCond /var/cache/naemon/thruk/thruk.pid       !-f
RewriteRule ^(.*)$                   http://%{HTTP_HOST}/naemon/startup.html?$1 [R=302,L,NE,QSA]

# redirect /thruk to new url, as the pkgs conflict anyway, this help migrating...
RewriteRule ^/thruk(.*)$             /naemon$1 [R=302,L]

# cookie based authentication
RewriteEngine On
RewriteMap  thruk_users              prg:/usr/share/naemon/thruk_auth
RewriteCond %{REQUEST_URI}           !^/naemon/cgi-bin/restricted.cgi
RewriteCond %{REQUEST_URI}           ^/naemon
RewriteCond %{HTTP_COOKIE}           (thruk_auth=[^;]+|$)  [NC]
RewriteRule ^/(.*)$                  /%1/%{REMOTE_ADDR}/____/$1/____/%{QUERY_STRING} [C,NS]
RewriteRule ^(.*)$                   ${thruk_users:$1|/loginbad/} [C,NS]
RewriteRule ^/pass/(.*)$             /$1 [NS,PT,L,E=!REMOTE_USER]
RewriteRule ^/redirect/(.*)$         http://%{HTTP_HOST}/$1 [NS,L,R=302]
RewriteRule ^/loginok/([^/]+)/(.*)$  /$2 [NS,PT,L,E=REMOTE_USER:$1]

# finally exclude everything from basic auth, except the restricted.cgi
<LocationMatch ^/naemon(?!/cgi-bin/restricted.cgi)>
  Order allow,deny
  Allow from all
  Satisfy any
</LocationMatch>
